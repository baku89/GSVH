var GL_MAX_WIDTH, GSVPANO, tiles;

GSVPANO = GSVPANO || {};

GL_MAX_WIDTH = 4096;

tiles = null;

GSVPANO.PanoLoader = (function() {
  var _applyRotFx, _composeFromTile, _count, _ctx, _heading, _hqCanvas, _hqCtx, _originHeading, _originPitch, _panoClient, _rotFx, _throwError, _tilesCanvas, _total, _zoom;

  _zoom = null;

  _panoClient = new google.maps.StreetViewService();

  _count = 0;

  _total = 0;

  _heading = 0;

  _originHeading = 0;

  _originPitch = 0;

  _tilesCanvas = document.createElement('canvas');

  _hqCanvas = document.createElement('canvas');

  _ctx = _tilesCanvas.getContext('2d');

  _hqCtx = _hqCanvas.getContext('2d');

  _rotFx = null;

  function PanoLoader(parameters) {
    var ref;
    parameters = parameters != null ? parameters : {};
    _rotFx = Glsl({
      canvas: document.createElement('canvas'),
      fragment: document.getElementById("pano-rotation").textContent,
      variables: {
        heading: 0.0,
        pitch: 0.0,
        original: _tilesCanvas,
        size: [0.0, 0.0],
        offset: [0.0, 0.0]
      }
    });
    this.onError = null;
    this.onProgress = function() {};
    this.onSizeChange = function() {};
    this.onPanoramaLoad = function() {};
    this.setZoom((ref = parameters.zoom) != null ? ref : 2);
    this.c2 = _tilesCanvas;
    $('[name=width], [name=height]').on('change', function() {
      _rotFx.setSize(parseInt($('[name=width]').val()), parseInt($('[name=height]').val()));
      _rotFx.syncAll();
      return _rotFx.render();
    });
  }

  _throwError = function(message) {
    if (this.onError != null) {
      return this.onError(message);
    } else {
      return console.error(message);
    }
  };

  _composeFromTile = function(x, y, texture) {
    var p;
    _ctx.drawImage(texture, x * 512, y * 512);
    _count++;
    p = Math.round(_count * 100 / _total);
    this.onProgress(p);
    if (_count === _total) {
      _applyRotFx.call(this);
      return this.onPanoramaLoad();
    }
  };

  _applyRotFx = function() {
    var glh, glw, h, i, j, ref, ref1, w, x, y;
    _rotFx.set('heading', (_originHeading - _heading).toRad());
    _rotFx.set('pitch', _originPitch.toRad());
    if (this.width < GL_MAX_WIDTH && this.height < GL_MAX_WIDTH) {
      _rotFx.setSize(this.width, this.height);
      _rotFx.set('size', [this.width, this.height]);
      _rotFx.set('offset', [0.0, 0.0]);
      _rotFx.syncAll();
      _rotFx.render();
      return this.canvas = _rotFx.canvas;
    } else {
      _hqCanvas.width = this.width;
      _hqCanvas.height = this.height;
      w = Math.ceil(this.width / GL_MAX_WIDTH);
      h = Math.ceil(this.height / GL_MAX_WIDTH);
      x = y = 0;
      glw = Math.min(this.width, GL_MAX_WIDTH);
      glh = Math.min(this.height, GL_MAX_WIDTH);
      _rotFx.setSize(glw, glh);
      _rotFx.set('size', [this.width, this.height]);
      for (y = i = 0, ref = h - 1; 0 <= ref ? i <= ref : i >= ref; y = 0 <= ref ? ++i : --i) {
        for (x = j = 0, ref1 = w - 1; 0 <= ref1 ? j <= ref1 : j >= ref1; x = 0 <= ref1 ? ++j : --j) {
          _rotFx.set('offset', [x * GL_MAX_WIDTH, y * GL_MAX_WIDTH]);
          _rotFx.syncAll();
          _rotFx.render();
          _hqCtx.drawImage(_rotFx.canvas, x * GL_MAX_WIDTH, this.height - (y + 1) * glh);
        }
      }
      return this.canvas = _hqCanvas;
    }
  };

  PanoLoader.prototype.composePanorama = function(panoId, heading) {
    _heading = heading != null ? heading : 0;
    this.onProgress(0);
    return _panoClient.getPanoramaById(panoId, (function(_this) {
      return function(data, status) {
        var h, i, ref, results, url, w, x, y;
        if (status !== google.maps.StreetViewStatus.OK) {
          _throwError("Cound not retrieve panorama for the following reason: wrong pano id");
          return;
        }
        tiles = data.tiles;
        _originHeading = tiles.originHeading;
        _originPitch = tiles.originPitch;
        w = Math.ceil(_this.width / 512);
        h = Math.ceil(_this.height / 512);
        x = y = 0;
        url = null;
        _count = 0;
        _total = w * h;
        results = [];
        for (y = i = 0, ref = h - 1; 0 <= ref ? i <= ref : i >= ref; y = 0 <= ref ? ++i : --i) {
          results.push((function() {
            var j, ref1, results1;
            results1 = [];
            for (x = j = 0, ref1 = w - 1; 0 <= ref1 ? j <= ref1 : j >= ref1; x = 0 <= ref1 ? ++j : --j) {
              url = "https://cbks0.googleapis.com/cbk?output=tile&zoom=" + _zoom + "&x=" + x + "&y=" + y + "&panoid=" + panoId + "&" + (Date.now());
              results1.push((function(_this) {
                return function(x, y) {
                  var img;
                  img = new Image();
                  img.onload = function() {
                    return _composeFromTile.call(_this, x, y, img);
                  };
                  img.crossOrigin = "";
                  return img.src = url;
                };
              })(this)(x, y));
            }
            return results1;
          }).call(_this));
        }
        return results;
      };
    })(this));
  };

  PanoLoader.prototype.setZoom = function(z) {
    _zoom = z;
    this.width = 416 * Math.pow(2, _zoom);
    this.height = 416 * Math.pow(2, _zoom - 1);
    _tilesCanvas.width = this.width;
    _tilesCanvas.height = this.height;
    _ctx.translate(_tilesCanvas.width, 0);
    _ctx.scale(-1, 1);
    _rotFx.setSize(this.width, this.height);
    return this.onSizeChange();
  };

  return PanoLoader;

})();

//# sourceMappingURL=data:application/json;base64,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QUMsQ0FBQTtJQUN2QixJQUFJLENBQUMsU0FBTCxDQUFnQixZQUFZLENBQUMsS0FBN0IsRUFBb0MsQ0FBcEM7SUFDQSxJQUFJLENBQUMsS0FBTCxDQUFXLENBQUMsQ0FBWixFQUFlLENBQWY7SUFFQSxNQUFNLENBQUMsT0FBUCxDQUFlLElBQUMsQ0FBQSxLQUFoQixFQUF1QixJQUFDLENBQUEsTUFBeEI7V0FFQSxJQUFDLENBQUEsWUFBRCxDQUFBO0VBYlEiLCJmaWxlIjoiR1NWUGFuby5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyIsInNvdXJjZXNDb250ZW50IjpbIkdTVlBBTk8gPSBHU1ZQQU5PIHx8IHt9XG5cbkdMX01BWF9XSURUSCA9IDQwOTZcblxudGlsZXMgPSBudWxsXG5cbmNsYXNzIEdTVlBBTk8uUGFub0xvYWRlclxuXG5cdCMgcHJpdmF0ZSB2YXJpYWJsZXNcblx0X3pvb20gPSBudWxsXG5cdF9wYW5vQ2xpZW50ID0gbmV3IGdvb2dsZS5tYXBzLlN0cmVldFZpZXdTZXJ2aWNlKClcblx0X2NvdW50ID0gMFxuXHRfdG90YWwgPSAwXG5cdF9oZWFkaW5nID0gMFxuXHRfb3JpZ2luSGVhZGluZyA9IDBcblx0X29yaWdpblBpdGNoID0gMFxuXHRfdGlsZXNDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKVxuXHRfaHFDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKVxuXHRfY3R4ID0gX3RpbGVzQ2FudmFzLmdldENvbnRleHQoJzJkJylcblx0X2hxQ3R4ID0gX2hxQ2FudmFzLmdldENvbnRleHQoJzJkJylcblx0X3JvdEZ4ID0gbnVsbFxuXG5cdGNvbnN0cnVjdG9yOiAocGFyYW1ldGVycykgLT5cblx0XHRwYXJhbWV0ZXJzID0gcGFyYW1ldGVycyA/IHt9XG5cblx0XHRfcm90RnggPSBHbHNsXG5cdFx0XHRjYW52YXM6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpXG5cdFx0XHRmcmFnbWVudDogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJwYW5vLXJvdGF0aW9uXCIpLnRleHRDb250ZW50XG5cdFx0XHR2YXJpYWJsZXM6XG5cdFx0XHRcdGhlYWRpbmc6ICAwLjBcblx0XHRcdFx0cGl0Y2g6IDAuMFxuXHRcdFx0XHRvcmlnaW5hbDogX3RpbGVzQ2FudmFzXG5cdFx0XHRcdHNpemU6IFswLjAsIDAuMF1cblx0XHRcdFx0b2Zmc2V0OiBbMC4wLCAwLjBdXG5cblx0XHQjIGV2ZW50XG5cdFx0QG9uRXJyb3IgPSBudWxsXG5cdFx0QG9uUHJvZ3Jlc3MgPSAoKSAtPlxuXHRcdEBvblNpemVDaGFuZ2UgPSAoKSAtPlxuXHRcdEBvblBhbm9yYW1hTG9hZCA9ICgpIC0+XG5cblx0XHRAc2V0Wm9vbSggcGFyYW1ldGVycy56b29tID8gMiApXG5cblx0XHRAYzIgPSBfdGlsZXNDYW52YXNcblxuXHRcdCQoJ1tuYW1lPXdpZHRoXSwgW25hbWU9aGVpZ2h0XScpLm9uICdjaGFuZ2UnLCAtPlxuXHRcdFx0X3JvdEZ4LnNldFNpemUoIHBhcnNlSW50KCQoJ1tuYW1lPXdpZHRoXScpLnZhbCgpKSwgcGFyc2VJbnQoJCgnW25hbWU9aGVpZ2h0XScpLnZhbCgpKSApXG5cdFx0XHRfcm90Rnguc3luY0FsbCgpXG5cdFx0XHRfcm90RngucmVuZGVyKClcblxuXHRcdFxuXHQjIHByaXZhdGUgTWV0aG9kXG5cdF90aHJvd0Vycm9yID0gKG1lc3NhZ2UpIC0+XG5cdFx0aWYgdGhpcy5vbkVycm9yP1xuXHRcdFx0dGhpcy5vbkVycm9yKG1lc3NhZ2UpXG5cdFx0ZWxzZVxuXHRcdFx0Y29uc29sZS5lcnJvcihtZXNzYWdlKVxuXG5cdF9jb21wb3NlRnJvbVRpbGUgPSAoeCwgeSwgdGV4dHVyZSkgLT5cblx0XHRfY3R4LmRyYXdJbWFnZSh0ZXh0dXJlLCB4ICogNTEyLCB5ICogNTEyKVxuXHRcdF9jb3VudCsrXG5cdFx0XG5cdFx0cCA9IE1hdGgucm91bmQoX2NvdW50ICogMTAwIC8gX3RvdGFsKVxuXHRcdEBvblByb2dyZXNzKHApXG5cdFx0XG5cdFx0aWYgX2NvdW50ID09IF90b3RhbFxuXHRcdFx0X2FwcGx5Um90RnguY2FsbChAKVxuXHRcdFx0QG9uUGFub3JhbWFMb2FkKClcblxuXHRfYXBwbHlSb3RGeCA9IC0+XG5cblx0XHRfcm90Rnguc2V0KCdoZWFkaW5nJywgKF9vcmlnaW5IZWFkaW5nIC0gX2hlYWRpbmcpLnRvUmFkKCkpXG5cdFx0X3JvdEZ4LnNldCgncGl0Y2gnLCBfb3JpZ2luUGl0Y2gudG9SYWQoKSlcblxuXHRcdGlmIEB3aWR0aCA8IEdMX01BWF9XSURUSCAmJiBAaGVpZ2h0IDwgR0xfTUFYX1dJRFRIXG5cdFx0XHQjIG5vcm1hbFxuXHRcdFx0X3JvdEZ4LnNldFNpemUoQHdpZHRoLCBAaGVpZ2h0KVxuXHRcdFx0X3JvdEZ4LnNldCgnc2l6ZScsIFtAd2lkdGgsIEBoZWlnaHRdKVxuXHRcdFx0X3JvdEZ4LnNldCgnb2Zmc2V0JywgWzAuMCwgMC4wXSlcblx0XHRcdF9yb3RGeC5zeW5jQWxsKClcblx0XHRcdF9yb3RGeC5yZW5kZXIoKVxuXG5cdFx0XHRAY2FudmFzID0gX3JvdEZ4LmNhbnZhc1xuXG5cdFx0ZWxzZVxuXHRcdFx0IyB0aWxpbmdcblx0XHRcdF9ocUNhbnZhcy53aWR0aCA9IEB3aWR0aFxuXHRcdFx0X2hxQ2FudmFzLmhlaWdodCA9IEBoZWlnaHRcblxuXHRcdFx0dyA9IE1hdGguY2VpbChAd2lkdGggLyBHTF9NQVhfV0lEVEgpXG5cdFx0XHRoID0gTWF0aC5jZWlsKEBoZWlnaHQgLyBHTF9NQVhfV0lEVEgpXG5cdFx0XHR4ID0geSA9IDBcblxuXHRcdFx0Z2x3ID0gTWF0aC5taW4oQHdpZHRoLCBHTF9NQVhfV0lEVEgpXG5cdFx0XHRnbGggPSBNYXRoLm1pbihAaGVpZ2h0LCBHTF9NQVhfV0lEVEgpXG5cdFx0XHRcblx0XHRcdF9yb3RGeC5zZXRTaXplKGdsdywgZ2xoKVxuXHRcdFx0X3JvdEZ4LnNldCgnc2l6ZScsIFtAd2lkdGgsIEBoZWlnaHRdKVxuXG5cdFx0XHRmb3IgeSBpbiBbMC4uaC0xXVxuXHRcdFx0XHRmb3IgeCBpbiBbMC4udy0xXVxuXHRcdFx0XHRcdF9yb3RGeC5zZXQoJ29mZnNldCcsIFt4ICogR0xfTUFYX1dJRFRILCB5ICogR0xfTUFYX1dJRFRIXSlcblx0XHRcdFx0XHRfcm90Rnguc3luY0FsbCgpXG5cdFx0XHRcdFx0X3JvdEZ4LnJlbmRlcigpXG5cblx0XHRcdFx0XHRfaHFDdHguZHJhd0ltYWdlKF9yb3RGeC5jYW52YXMsXG5cdFx0XHRcdFx0XHR4ICogR0xfTUFYX1dJRFRILFxuXHRcdFx0XHRcdFx0QGhlaWdodCAtICh5KzEpICogZ2xoKVxuXG5cdFx0XHRAY2FudmFzID0gX2hxQ2FudmFzXG5cblxuXHQjIFB1YmxpYyBNZXRob2Rcblx0Y29tcG9zZVBhbm9yYW1hOiAocGFub0lkLCBoZWFkaW5nKSAtPlxuXHRcdFxuXHRcdF9oZWFkaW5nID0gaGVhZGluZyA/IDBcblx0XG5cdFx0QG9uUHJvZ3Jlc3MoMClcblxuXHRcdF9wYW5vQ2xpZW50LmdldFBhbm9yYW1hQnlJZCBwYW5vSWQsIChkYXRhLCBzdGF0dXMpID0+XG5cdFx0XHRpZiBzdGF0dXMgIT0gZ29vZ2xlLm1hcHMuU3RyZWV0Vmlld1N0YXR1cy5PS1xuXHRcdFx0XHRfdGhyb3dFcnJvcihcIkNvdW5kIG5vdCByZXRyaWV2ZSBwYW5vcmFtYSBmb3IgdGhlIGZvbGxvd2luZyByZWFzb246IHdyb25nIHBhbm8gaWRcIilcblx0XHRcdFx0cmV0dXJuXG5cblx0XHRcdHRpbGVzID0gZGF0YS50aWxlc1xuXG5cdFx0XHRfb3JpZ2luSGVhZGluZyA9IHRpbGVzLm9yaWdpbkhlYWRpbmdcblx0XHRcdF9vcmlnaW5QaXRjaCAgID0gdGlsZXMub3JpZ2luUGl0Y2hcblxuXHRcdFx0dyA9IE1hdGguY2VpbChAd2lkdGggLyA1MTIpXG5cdFx0XHRoID0gTWF0aC5jZWlsKEBoZWlnaHQgLyA1MTIpXG5cblx0XHRcdHggPSB5ID0gMFxuXHRcdFx0dXJsID0gbnVsbFxuXG5cdFx0XHRfY291bnQgPSAwXG5cdFx0XHRfdG90YWwgPSB3ICogaFxuXG5cdFx0XHRmb3IgeSBpbiBbMC4uaC0xXVxuXHRcdFx0XHRmb3IgeCBpbiBbMC4udy0xXVxuXHRcdFx0XHRcdHVybCA9IFwiaHR0cHM6Ly9jYmtzMC5nb29nbGVhcGlzLmNvbS9jYms/b3V0cHV0PXRpbGUmem9vbT0je196b29tfSZ4PSN7eH0meT0je3l9JnBhbm9pZD0je3Bhbm9JZH0mI3tEYXRlLm5vdygpfVwiXG5cblx0XHRcdFx0XHRkbyAoeCwgeSkgPT5cblx0XHRcdFx0XHRcdGltZyA9IG5ldyBJbWFnZSgpXG5cdFx0XHRcdFx0XHRpbWcub25sb2FkID0gPT5cblx0XHRcdFx0XHRcdFx0X2NvbXBvc2VGcm9tVGlsZS5jYWxsKEAsIHgsIHksIGltZylcblx0XHRcdFx0XHRcdGltZy5jcm9zc09yaWdpbiA9IFwiXCJcblx0XHRcdFx0XHRcdGltZy5zcmMgPSB1cmxcblx0XG5cdHNldFpvb206ICggeiApIC0+XG5cdFx0X3pvb20gPSB6XG5cdFx0XG5cdFx0QHdpZHRoID0gNDE2ICogTWF0aC5wb3coMiwgX3pvb20pXG5cdFx0QGhlaWdodCA9ICg0MTYgKiBNYXRoLnBvdygyLCBfem9vbSAtIDEpKVxuXG5cdFx0X3RpbGVzQ2FudmFzLndpZHRoID0gQHdpZHRoXG5cdFx0X3RpbGVzQ2FudmFzLmhlaWdodCA9IEBoZWlnaHRcblx0XHRfY3R4LnRyYW5zbGF0ZSggX3RpbGVzQ2FudmFzLndpZHRoLCAwKVxuXHRcdF9jdHguc2NhbGUoLTEsIDEpXG5cblx0XHRfcm90Rnguc2V0U2l6ZShAd2lkdGgsIEBoZWlnaHQpXG5cblx0XHRAb25TaXplQ2hhbmdlKClcblxuXG5cblx0XHRcblxuIl19