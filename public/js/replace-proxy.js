var $console, basename, canvas, compose, ctx, decode, err, fileList, fs, gsvh, gui, load, log, nativeMenuBar, onComplete, panoList, path, savePano, srcDir, win;

fs = require('fs');

path = require('path');

gui = require('nw.gui');

win = gui.Window.get();

nativeMenuBar = new gui.Menu({
  type: 'menubar'
});

try {
  nativeMenuBar.createMacBuiltin('gi-eye');
  win.menu = nativeMenuBar;
} catch (_error) {
  err = _error;
  console.log(err.message);
}

panoList = [];

canvas = ctx = null;

srcDir = null;

fileList = null;

gsvh = null;

canvas = document.cleateElement('canvas');

basename = null;

$console = null;

log = function(str) {
  $console.append(str + "\n");
  return $console.scrollTop = $console.scrollHeight;
};

$(function() {
  $console = $('#console');
  $('#replace-proxy').sisyphus();
  canvas = $('#pv')[0];
  ctx = canvas.getContext('2d');
  $('#decode').on('click', decode);
  return $('[name=file]').on('change', function() {
    $('[name=source]').val($('[name=file]').val());
    return sisyphus.saveAllData();
  });
});

decode = function() {
  srcDir = $('[name=source]').val();
  if (srcDir === "") {
    alert("please select source directory");
    return;
  }
  return fs.readdir(srcDir, function(err, files) {
    var f;
    if (err) {
      throw err;
    }
    fileList = (function() {
      var i, len, results;
      results = [];
      for (i = 0, len = files.length; i < len; i++) {
        f = files[i];
        if (/\.png$/.test(f)) {
          results.push(f);
        }
      }
      return results;
    })();
    basename = path.basename(srcDir);
    return load();
  });
};

load = function() {
  var e, img, next;
  log("loading..");
  try {
    fs.mkdirSync((path.dirname(srcDir)) + "/" + basename + ".HQ");
  } catch (_error) {
    e = _error;
    console.log(e);
  }
  img = new Image();
  next = function(idx) {
    var filename;
    img.onload = function() {
      var pano;
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
      pano = CanvasMatrixCode.decode(canvas, 0, canvas.height - 30, canvas.width, 30);
      pano.filename = filename;
      panoList.push(pano);
      if (++idx < fileList.length) {
        return next(idx);
      } else {
        return compose();
      }
    };
    filename = fileList[idx];
    return img.src = "file:///" + srcDir + "/" + filename;
  };
  return next(0);
};

compose = function() {
  log("composing..");
  gsvh = new GSVHyperlapse(basename, $('#pv')[0]);
  gsvh.setParameters({
    zoom: 4
  });
  gsvh.panoList = panoList;
  GSVHyperlapse.onMessage = log;
  GSVHyperlapse.onProgress = function(loaded, total) {
    return log("composed (" + loaded + "/" + total + ")");
  };
  GSVHyperlapse.onPanoramaLoad = savePano;
  GSVHyperlapse.onComposeComplete = onComplete;
  return gsvh.compose();
};

savePano = function(idx, pano, data) {
  return $('#pano').append(pano);
};

onComplete = function() {
  return null;
};

//# sourceMappingURL=data:application/json;base64,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QUFDLGNBQWQsR0FBZ0MsUUFYaEMsQ0FBQTtBQUFBLEVBWUEsYUFBYSxDQUFDLGlCQUFkLEdBQWtDLFVBWmxDLENBQUE7U0FjQSxJQUFJLENBQUMsT0FBTCxDQUFBLEVBZlM7QUFBQSxDQXhHVixDQUFBOztBQUFBLFFBMkhBLEdBQVcsU0FBQyxHQUFELEVBQU0sSUFBTixFQUFZLElBQVosR0FBQTtTQUVWLENBQUEsQ0FBRSxPQUFGLENBQVUsQ0FBQyxNQUFYLENBQW1CLElBQW5CLEVBRlU7QUFBQSxDQTNIWCxDQUFBOztBQUFBLFVBZ0lBLEdBQWEsU0FBQSxHQUFBO1NBQ1osS0FEWTtBQUFBLENBaEliLENBQUEiLCJmaWxlIjoicmVwbGFjZS1wcm94eS5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyIsInNvdXJjZXNDb250ZW50IjpbImZzIFx0XHQ9IHJlcXVpcmUgJ2ZzJ1xucGF0aFx0PSByZXF1aXJlICdwYXRoJ1xuZ3VpIFx0PSByZXF1aXJlICdudy5ndWknXG5cbiMtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiMgd2luZG93IHNldHVwXG5cbndpbiA9IGd1aS5XaW5kb3cuZ2V0KClcbm5hdGl2ZU1lbnVCYXIgPSBuZXcgZ3VpLk1lbnUoe3R5cGU6ICdtZW51YmFyJ30pXG5cbnRyeVxuXHRuYXRpdmVNZW51QmFyLmNyZWF0ZU1hY0J1aWx0aW4oJ2dpLWV5ZScpXG5cdHdpbi5tZW51ID0gbmF0aXZlTWVudUJhclxuY2F0Y2ggZXJyXG5cdGNvbnNvbGUubG9nIGVyci5tZXNzYWdlXG5cbiMtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbnBhbm9MaXN0ID0gW11cbmNhbnZhcyA9IGN0eCA9IG51bGxcbnNyY0RpciA9IG51bGxcbmZpbGVMaXN0ID0gbnVsbFxuXG5nc3ZoID0gbnVsbFxuXG5jYW52YXMgPSBkb2N1bWVudC5jbGVhdGVFbGVtZW50KCdjYW52YXMnKVxuXG5iYXNlbmFtZSA9IG51bGxcbiRjb25zb2xlID0gbnVsbFxuXG5sb2cgPSAoc3RyKSAtPlxuXHQkY29uc29sZS5hcHBlbmQoXCIje3N0cn1cXG5cIilcblx0JGNvbnNvbGUuc2Nyb2xsVG9wID0gJGNvbnNvbGUuc2Nyb2xsSGVpZ2h0XG5cbiQgLT5cblx0JGNvbnNvbGUgPSAkKCcjY29uc29sZScpXG5cblx0JCgnI3JlcGxhY2UtcHJveHknKS5zaXN5cGh1cygpXG5cblx0Y2FudmFzID0gJCgnI3B2JylbMF1cblx0Y3R4ID0gY2FudmFzLmdldENvbnRleHQoJzJkJylcblxuXHQkKCcjZGVjb2RlJykub24gJ2NsaWNrJywgZGVjb2RlXG5cblx0JCgnW25hbWU9ZmlsZV0nKS5vbiAnY2hhbmdlJywgLT5cblx0XHQkKCdbbmFtZT1zb3VyY2VdJylcblx0XHRcdC52YWwoICQoJ1tuYW1lPWZpbGVdJykudmFsKCkgKVxuXHRcdHNpc3lwaHVzLnNhdmVBbGxEYXRhKClcblxuXG5cblxuIy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuZGVjb2RlID0gLT5cblx0c3JjRGlyID0gJCgnW25hbWU9c291cmNlXScpLnZhbCgpXG5cblx0aWYgc3JjRGlyID09IFwiXCJcblx0XHRhbGVydCBcInBsZWFzZSBzZWxlY3Qgc291cmNlIGRpcmVjdG9yeVwiXG5cdFx0cmV0dXJuXG5cblx0ZnMucmVhZGRpciBzcmNEaXIsIChlcnIsIGZpbGVzKSAtPlxuXHRcdGlmIGVyciB0aGVuIHRocm93IGVyclxuXG5cdFx0ZmlsZUxpc3QgPSAoZiBmb3IgZiBpbiBmaWxlcyB3aGVuIC9cXC5wbmckLy50ZXN0KGYpKVxuXHRcdGJhc2VuYW1lID0gcGF0aC5iYXNlbmFtZSggc3JjRGlyIClcblxuXHRcdGxvYWQoKVxuXG5cbiMtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbmxvYWQgPSAoKSAtPlxuXHRsb2coXCJsb2FkaW5nLi5cIilcblxuXHQjIG1ha2UgbmV3IGRpcmVjdG9yeVxuXHR0cnlcblx0XHRmcy5ta2RpclN5bmMoXCIje3BhdGguZGlybmFtZShzcmNEaXIpfS8je2Jhc2VuYW1lfS5IUVwiKVxuXHRjYXRjaCBlXG5cdFx0Y29uc29sZS5sb2cgZVxuXG5cdGltZyA9IG5ldyBJbWFnZSgpXG5cblx0bmV4dCA9IChpZHgpIC0+XG5cdFx0aW1nLm9ubG9hZCA9IC0+XG5cblx0XHRcdGNhbnZhcy53aWR0aCA9IGltZy53aWR0aFxuXHRcdFx0Y2FudmFzLmhlaWdodCA9IGltZy5oZWlnaHRcblxuXHRcdFx0Y3R4LmRyYXdJbWFnZShpbWcsIDAsIDApXG5cblx0XHRcdHBhbm8gPSBDYW52YXNNYXRyaXhDb2RlLmRlY29kZShjYW52YXMsIDAsIGNhbnZhcy5oZWlnaHQgLSAzMCwgY2FudmFzLndpZHRoLCAzMClcblx0XHRcdHBhbm8uZmlsZW5hbWUgPSBmaWxlbmFtZVxuXG5cdFx0XHRwYW5vTGlzdC5wdXNoKCBwYW5vIClcblxuXHRcdFx0aWYgKytpZHggPCBmaWxlTGlzdC5sZW5ndGhcblx0XHRcdFx0bmV4dChpZHgpXG5cdFx0XHRlbHNlIFxuXHRcdFx0XHRjb21wb3NlKClcblxuXHRcdGZpbGVuYW1lID0gZmlsZUxpc3RbaWR4XVxuXHRcdGltZy5zcmMgPSBcImZpbGU6Ly8vI3tzcmNEaXJ9LyN7ZmlsZW5hbWV9XCJcblxuXHRuZXh0KDApXG5cbiMtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbmNvbXBvc2UgPSAtPlxuXHRsb2coXCJjb21wb3NpbmcuLlwiKVxuXG5cdGdzdmggPSBuZXcgR1NWSHlwZXJsYXBzZSggYmFzZW5hbWUsICQoJyNwdicpWzBdIClcblx0Z3N2aC5zZXRQYXJhbWV0ZXJzXG5cdFx0em9vbTogNFxuXHRnc3ZoLnBhbm9MaXN0ID0gcGFub0xpc3RcblxuXHRHU1ZIeXBlcmxhcHNlLm9uTWVzc2FnZSA9IGxvZ1xuXHRHU1ZIeXBlcmxhcHNlLm9uUHJvZ3Jlc3MgPSAobG9hZGVkLCB0b3RhbCkgLT5cblx0XHRsb2coXCJjb21wb3NlZCAoI3tsb2FkZWR9LyN7dG90YWx9KVwiKVxuXG5cdEdTVkh5cGVybGFwc2Uub25QYW5vcmFtYUxvYWQgPSAgc2F2ZVBhbm9cblx0R1NWSHlwZXJsYXBzZS5vbkNvbXBvc2VDb21wbGV0ZSA9IG9uQ29tcGxldGVcblxuXHRnc3ZoLmNvbXBvc2UoKVxuXG5cbiMtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbnNhdmVQYW5vID0gKGlkeCwgcGFubywgZGF0YSkgLT5cblxuXHQkKCcjcGFubycpLmFwcGVuZCggcGFubyApXG5cbiMtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbm9uQ29tcGxldGUgPSAtPlxuXHRudWxsXG5cblxuXHRcblxuXG4iXX0=